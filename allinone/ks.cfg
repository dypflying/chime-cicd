
auth --enableshadow --passalgo=sha512

cdrom

graphical

firstboot --enable

keyboard --vckeymap=us --xlayouts='us'

lang en_US.UTF-8

network --bootproto=dhcp --device=eth0 --ipv6=auto --activate

network --hostname=chime1

rootpw --iscrypted $1$.N3uZx0T$BoYfln1jVV2slVaFq.B.1/

services --disabled="chronyd"

selinux --disabled

firewall --disabled

timezone Asia/Shanghai --isUtc --nontp

bootloader --location=mbr --boot-drive=nvme0n1

zerombr

clearpart --all

part /boot --fstype="xfs" --size=200
part / --fstype="xfs" --size=1 --grow

%packages
@^minimal
@core
%end

%addon com_redhat_kdump --disable --reserve-mb='auto'
%end

%anaconda

pwpolicy root --minlen=5 --minquality=1 --notstrict --nochanges --notempty
pwpolicy user --minlen=5 --minquality=1 --notstrict --nochanges --emptyok
pwpolicy luks --minlen=5 --minquality=1 --notstrict --nochanges --notempty

%end

%post

mkdir -p /etc/yum.repos.d/backup
mv /etc/yum.repos.d/CentOS-* /etc/yum.repos.d/backup/
mkdir -p /mnt/cdrom
mount /dev/sr0 /mnt/cdrom
cp /mnt/cdrom/packages/CentOS-Base.repo /etc/yum.repos.d/ 
yum update

yum localinstall -y /mnt/cdrom/packages/influxdb/influxdb2-2.7.5-1.x86_64.rpm >> /tmp/chime-install.log 2>&1 
tar xvf /mnt/cdrom/packages/influxdb/influxdb2-client-2.7.3-linux-amd64.tar.gz -C /tmp/
cp /tmp/influx /usr/bin/ 
systemctl start influxdb
systemctl enable influxdb
sleep 3
/usr/bin/influx setup --username chime-user --password passw0rd --token hshuKMUoyEyfjl-aWwd_PS1oRNTL2LhwyaZhTLuJink63BsqM-QoV4qJ-IYtbnTCMBM8wG0FjX7wW4JPF-RiMg== --org chime --bucket chime --force --name chime >> /tmp/chime-install.log 2>&1

dnf install -y mysql-server >> /tmp/chime-install.log 2>&1
systemctl start mysqld
systemctl enable mysqld 
sleep 3
/usr/bin/mysql < /mnt/cdrom/packages/mysql/chime.sql >> /tmp/chime-install.log 2>&1
/usr/bin/mysql < /mnt/cdrom/packages/mysql/portal.sql >> /tmp/chime-install.log 2>&1

dnf install -y qemu-kvm libvirt genisoimage >> /tmp/chime-install.log 2>&1
systemctl enable libvirtd

dnf install -y /mnt/cdrom/packages/minio/minio.rpm >> /tmp/chime-install.log 2>&1
cp /mnt/cdrom/packages/minio/minio /etc/default/minio
mkdir -p /mnt/minio
cp -R /mnt/cdrom/packages/minio/data/* /mnt/minio/

mkdir -p /etc/chime 
mkdir -p /var/lib/chime 
mkdir -p /var/lib/chime/portal/uploads
mkdir -p /var/lib/chime/uploads
mkdir -p /mnt/local/backend/volumes
mkdir -p /mnt/local/cache

cp /mnt/cdrom/packages/chime/chime-server /usr/bin/
cp /mnt/cdrom/packages/chime/chime-agent /usr/bin/
cp /mnt/cdrom/packages/chime/chimeadmr /usr/bin/
cp /mnt/cdrom/packages/chime/chimecli /usr/bin/
cp /mnt/cdrom/packages/chime/server.yaml /etc/chime/
cp /mnt/cdrom/packages/chime/agent.yaml /etc/chime/ 
cp /mnt/cdrom/packages/chime/librados.so.2.0.0 /lib64/
ln -sf /lib64/librados.so.2.0.0 /lib64/librados.so.2 
ln -sf /lib64/librados.so.2 /lib64/librados.so
cp /mnt/cdrom/packages/chime/librbd.so.1.17.0 /lib64/
ln -sf /lib64/librbd.so.1.17.0 librbd.so.1 
cp /mnt/cdrom/packages/chime/libceph-common.so.2 /lib64/ceph/
ln -sf /lib64/ceph/libceph-common.so.2 /lib64/ceph/libceph-common.so
cp /mnt/cdrom/packages/chime/chime-server.service /usr/lib/systemd/system/
cp /mnt/cdrom/packages/chime/chime-agent.service /usr/lib/systemd/system/


%end

reboot
